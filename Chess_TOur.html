<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chess.Tour.7B | Tournament Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-body: #0a0a0a; --bg-card: #141414; --chess-green: #5c934a; --chess-green-bright: #7ac463;
            --text-main: #ffffff; --text-sub: #a0a0a0; --border: #222;
        }
        [data-theme="light"] {
            --bg-body: #f0f0f0; --bg-card: #ffffff; --chess-green: #4a7a3b; --chess-green-bright: #5c934a;
            --text-main: #121212; --text-sub: #666666; --border: #ccc;
        }

        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg-body); color: var(--text-main); transition: 0.3s; overflow-x: hidden; }
        .view { min-height: 100vh; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; position: relative; }
        .hidden { display: none !important; }

        /* Animations */
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes float { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-20px) rotate(5deg); } }
        
        .card { 
            background: var(--bg-card); border: 1px solid var(--border); padding: 20px; border-radius: 12px; margin-bottom: 20px; position: relative; 
            animation: slideUp 0.5s ease forwards;
        }

        /* Buttons & Inputs */
        .btn-main { background: var(--chess-green); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 1rem; }
        .btn-main:hover { transform: translateY(-2px); background: var(--chess-green-bright); box-shadow: 0 4px 15px rgba(92, 147, 74, 0.4); }
        .btn-loading { pointer-events: none; opacity: 0.7; }
        .btn-danger { background: #d9534f; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.7rem; font-weight: bold; transition: 0.2s; }
        .btn-danger:hover { background: #c9302c; }
        
        .input-field { background: #1a1a1a; border: 1px solid var(--border); color: white; padding: 12px; border-radius: 8px; margin: 5px 0; width: 100%; box-sizing: border-box; transition: 0.2s; font-size: 16px; }
        .input-field:focus { border-color: var(--chess-green); outline: none; box-shadow: 0 0 10px rgba(92,147,74,0.2); }

        /* Language Select In Header */
        .lang-select { background: #000; color: var(--text-main); border: 1px solid var(--border); padding: 5px; border-radius: 5px; font-size: 0.7rem; font-weight: bold; cursor: pointer; outline: none; }

        /* Login Screen Fun Styles */
        #login-page { justify-content: center; align-items: center; overflow: hidden; }
        .bg-pieces { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.05; pointer-events: none; }
        .bg-pieces i { position: absolute; color: var(--chess-green); animation: float 6s ease-in-out infinite; }
        .p1 { top: 10%; left: 10%; font-size: 10rem; animation-delay: 0s; }
        .p2 { bottom: 15%; right: 10%; font-size: 14rem; animation-delay: 2s; }
        .p3 { top: 30%; right: 20%; font-size: 8rem; animation-delay: 1s; }
        .p4 { bottom: 20%; left: 20%; font-size: 12rem; animation-delay: 3s; }
        
        .login-box {
            background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1);
            padding: 40px; border-radius: 20px; width: 100%; max-width: 400px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); z-index: 10; box-sizing: border-box;
        }

        /* Leaderboard & Inline Buttons */
        .inline-inc-btn { background: rgba(92, 147, 74, 0.2); color: var(--chess-green-bright); border: 1px solid var(--chess-green); padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: bold; transition: 0.2s; margin-left: 2px;}
        .inline-inc-btn:hover { background: var(--chess-green); color: white; transform: scale(1.1); }
        .lb-tabs { display: flex; gap: 5px; margin-bottom: 15px; background: #000; padding: 5px; border-radius: 8px; }
        .lb-tab { flex: 1; border: none; background: none; color: var(--text-sub); padding: 8px; cursor: pointer; border-radius: 5px; font-size: 0.8rem; transition: 0.3s; font-weight: bold; }
        .lb-tab.active { background: var(--chess-green); color: white; }

        .dashboard-grid { display: grid; grid-template-columns: 1fr 1.2fr 1fr; gap: 20px; max-width: 1500px; margin: 0 auto; width: 100%; }
        .item-row { background: #1a1a1a; padding: 12px; margin: 8px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; border-left: 3px solid transparent; word-break: break-all;}
        .item-row:hover { border-left-color: var(--chess-green); background: #222; }
        .item-row.is-you { border-left-color: var(--chess-green-bright); background: rgba(92, 147, 74, 0.1); }
        
        .admin-section { border: 1px dashed var(--chess-green); padding: 15px; border-radius: 10px; margin-top: 15px; background: rgba(92, 147, 74, 0.03); }
        .user-list-item { border-bottom: 1px solid var(--border); padding: 10px 0; display: flex; flex-direction: column; gap: 5px; }
        
        .role-badge { font-size: 0.65rem; padding: 3px 6px; border-radius: 4px; text-transform: uppercase; margin-left: 5px; font-weight: bold; letter-spacing: 0.5px; }
        .badge-admin { background: #d9534f; color: white; box-shadow: 0 0 5px #d9534f; }
        .badge-host { background: #f0ad4e; color: #000; }
        .badge-participant { background: #5bc0de; color: #000; }

        /* Floating Chat Bubble & Chat Window */
        .chat-fab { position: fixed; bottom: 30px; right: 30px; background: var(--chess-green); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.4); transition: 0.3s; z-index: 100; }
        .chat-fab:hover { transform: scale(1.1) rotate(10deg); }
        .chat-window { position: fixed; bottom: 100px; right: 30px; width: 350px; height: 450px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 15px; box-shadow: 0 15px 30px rgba(0,0,0,0.5); display: flex; flex-direction: column; z-index: 99; transition: 0.3s; opacity: 0; pointer-events: none; transform: translateY(20px); }
        .chat-window.open { opacity: 1; pointer-events: all; transform: translateY(0); }
        .chat-header { background: #000; padding: 15px; border-radius: 15px 15px 0 0; font-weight: bold; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;}
        .chat-body { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .chat-input-area { padding: 10px; background: #000; border-radius: 0 0 15px 15px; display: flex; gap: 10px; }
        
        .chat-msg { background: #1a1a1a; padding: 10px; border-radius: 10px; position: relative; font-size: 0.9rem; word-break: break-word;}
        .chat-msg .author { font-weight: bold; color: var(--chess-green); font-size: 0.75rem; margin-bottom: 3px; display: flex; align-items: center; gap: 5px;}
        
        .chat-msg.admin-msg { background: rgba(217, 83, 79, 0.1); border: 1px solid #d9534f; }
        .chat-msg.admin-msg .author { color: #d9534f; }
        .chat-msg.admin-msg .text-body { font-weight: bold; color: #fff; }
        
        .delete-msg-btn { position: absolute; top: 10px; right: 10px; color: #666; cursor: pointer; transition: 0.2s; font-size: 0.8rem; }
        .delete-msg-btn:hover { color: #d9534f; }
        
        /* Mobile Adjustments */
        @media (max-width: 1000px) { 
            .dashboard-grid { grid-template-columns: 1fr; } 
            .chat-window { bottom: 0; right: 0; width: 100%; height: 100vh; border-radius: 0; position: fixed; z-index: 1000; } 
            .chat-fab { bottom: 20px; right: 20px; z-index: 1001; }
            .chat-header { border-radius: 0; padding: 20px; }
            .chat-input-area { border-radius: 0; padding: 15px; padding-bottom: 30px; }
        }
    </style>
</head>
<body data-theme="dark">

    <section id="login-page" class="view">
        <div class="bg-pieces">
            <i class="fa-solid fa-chess-knight p1"></i>
            <i class="fa-solid fa-chess-rook p2"></i>
            <i class="fa-solid fa-chess-bishop p3"></i>
            <i class="fa-solid fa-chess-pawn p4"></i>
        </div>
        <div class="login-box">
            <h1 style="font-size: clamp(2.5rem, 8vw, 3rem); margin: 0 0 5px 0; font-weight: 800; letter-spacing: -1px;">Tour.<span style="color:var(--chess-green)">7B</span></h1>
            <p data-i18n="loginSub" style="color: var(--text-sub); margin-bottom: 30px; font-size: 0.9rem;">Ready your opening move.</p>
            <input type="text" id="login-user" class="input-field" data-i18n-ph="userPlaceholder" placeholder="Username">
            <input type="password" id="login-pass" class="input-field" data-i18n-ph="passPlaceholder" placeholder="Password">
            <button class="btn-main" style="width: 100%; margin-top: 20px; padding: 15px; font-size: 1.1rem;" id="doLogin">
                <span data-i18n="enterArena">Enter Arena</span> <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
    </section>

    <section id="dashboard-page" class="view hidden">
        <header style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0 30px 0; flex-wrap: wrap; gap: 10px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fa-solid fa-moon" id="theme-toggle" style="cursor:pointer; font-size: 1.3rem; color: var(--chess-green);"></i>
                <select id="lang-selector" class="lang-select">
                    <option value="en">ðŸ‡¬ðŸ‡§ EN</option>
                    <option value="de">ðŸ‡©ðŸ‡ª DE</option>
                    <option value="fr">ðŸ‡«ðŸ‡· FR</option>
                    <option value="ar">ðŸ‡¸ðŸ‡¦ AR</option>
                </select>
                <button onclick="window.doLogout()" style="background:none; border:1px solid #444; color:var(--text-sub); cursor:pointer; padding: 6px 12px; border-radius: 6px; font-size: 0.7rem; font-weight: bold;">LOGOUT</button>
            </div>
            <h2 style="font-weight: 800; font-size: 1.2rem; letter-spacing: -0.5px; margin:0;">Tour.<span style="color:var(--chess-green)">7B</span></h2>
            <div id="user-display" style="font-weight:bold; font-size: 0.85rem;">Connecting...</div>
        </header>

        <main class="dashboard-grid">
            <div class="dash-col">
                <div class="card">
                    <h3><i class="fa-solid fa-puzzle-piece" style="color:var(--chess-green)"></i> <span data-i18n="todayRiddle">Today's Riddle</span></h3>
                    <div id="riddle-view">
                        <img id="riddle-img" src="" style="width:100%; border-radius:8px; display:none; margin-bottom: 15px;">
                        <p id="riddle-text" style="color: var(--text-sub); line-height: 1.5;">Awaiting the first puzzle...</p>
                    </div>
                    <div class="role-admin hidden admin-section">
                        <input type="text" id="edit-riddle-text" class="input-field" placeholder="Description">
                        <input type="text" id="edit-riddle-url" class="input-field" placeholder="Image URL">
                        <button class="btn-main" id="saveRiddle" style="width:100%; margin-top: 10px;">Update Riddle</button>
                    </div>
                </div>

                <div class="card">
                    <h3><i class="fa-solid fa-gear" style="color:var(--chess-green)"></i> <span data-i18n="settingsTitle">Settings</span></h3>
                    <input type="password" id="change-pass-input" class="input-field" placeholder="New Password (6+ chars)">
                    <button class="btn-main" id="doChangePass" style="width:100%; margin-top:10px;" data-i18n="updatePass">Update Password</button>
                </div>

                <div class="card role-not-admin">
                    <h3><i class="fa-solid fa-headset" style="color:var(--chess-green)"></i> <span data-i18n="contactAdmin">Contact Admin</span></h3>
                    <textarea id="support-input" class="input-field" placeholder="Need help or reporting an issue?" rows="3"></textarea>
                    <button class="btn-main" id="sendSupport" style="width:100%" data-i18n="submitTicket">Submit Ticket</button>
                </div>
            </div>

            <div class="dash-col">
                <div class="card" style="min-height: 600px;">
                    <h3><i class="fa-solid fa-trophy" style="color: gold;"></i> <span data-i18n="leaderboard">Leaderboard</span></h3>
                    <div class="lb-tabs">
                        <button class="lb-tab active" id="tab-chess" data-i18n="chess">Chess</button>
                        <button class="lb-tab" id="tab-tricks" data-i18n="tricks">Tricks</button>
                        <button class="lb-tab" id="tab-global" data-i18n="global">Global</button>
                    </div>
                    <div id="lb-display"></div>
                    
                    <div class="role-admin hidden admin-section">
                        <h4>Point Override</h4>
                        <input type="text" id="lb-name" class="input-field" placeholder="Exact Player Name">
                        <div style="display:flex; gap:5px;">
                            <input type="number" id="lb-chess" class="input-field" placeholder="Set Chess Pts">
                            <input type="number" id="lb-trick" class="input-field" placeholder="Set Trick Pts">
                        </div>
                        <button class="btn-main" id="updateLB" style="width:100%; margin-top: 5px;">Force Save</button>
                    </div>
                </div>
            </div>

            <div class="dash-col">
                <div class="card role-admin hidden">
                    <h3><i class="fa-solid fa-inbox" style="color:var(--chess-green)"></i> <span data-i18n="adminInbox">Admin Inbox (Tickets)</span></h3>
                    <div id="inbox-container" style="max-height: 250px; overflow-y: auto; padding-right: 5px;"></div>
                </div>

                <div class="card role-admin hidden">
                    <h3><i class="fa-solid fa-users-gear" style="color:var(--chess-green)"></i> <span data-i18n="userMgmt">User Management</span></h3>
                    <div id="user-manager-list" style="margin-bottom: 15px; max-height: 300px; overflow-y:auto; padding-right: 5px;"></div>
                    
                    <div class="admin-section">
                        <h4>Create Account</h4>
                        <input type="text" id="new-name" class="input-field" placeholder="New Username">
                        <input type="password" id="new-pass" class="input-field" placeholder="Password">
                        <button class="btn-main" id="createUser" style="width:100%; margin-top: 10px;">Register User</button>
                    </div>

                    <div class="admin-section" style="margin-top: 15px;">
                        <h4>Link Account to Leaderboard</h4>
                        <input type="text" id="link-user" class="input-field" placeholder="Auth Username">
                        <input type="text" id="link-lb" class="input-field" placeholder="Leaderboard Name">
                        <button class="btn-main" id="doLink" style="width:100%; margin-top: 10px;">Link Data</button>
                    </div>
                </div>
            </div>
        </main>
    </section>

    <div class="chat-fab" id="chatToggleBtn"><i class="fa-solid fa-comments"></i></div>
    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <span>Live Chat</span>
            <i class="fa-solid fa-xmark" style="cursor:pointer; font-size: 1.2rem; padding: 5px;" id="chatCloseBtn"></i>
        </div>
        <div class="chat-body" id="chat-container"></div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" class="input-field" placeholder="Say something..." style="margin:0;">
            <button class="btn-main" id="sendChat" style="padding: 0 15px;"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, updatePassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, query, orderBy, getDoc, updateDoc, increment, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyClXt0-r-6bSpGEmzLLYpiAszGiW20GLkM",
            projectId: "b-tournament",
            storageBucket: "b-tournament.firebasestorage.app",
            messagingSenderId: "785284063880",
            appId: "1:785284063880:web:f078c8325b28926162f53d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserData = null;
        let lbRawData = [];
        let currentLBMode = 'chess';

        // --- TRANSLATION DICTIONARY ---
        const translations = {
            en: {
                loginSub: "Ready your opening move.", userPlaceholder: "Username", passPlaceholder: "Password", enterArena: "Enter Arena",
                todayRiddle: "Today's Riddle", settingsTitle: "Settings", updatePass: "Update Password", contactAdmin: "Contact Admin",
                submitTicket: "Submit Ticket", leaderboard: "Leaderboard", chess: "Chess", tricks: "Tricks", global: "Global",
                adminInbox: "Admin Inbox (Tickets)", userMgmt: "User Management"
            },
            de: {
                loginSub: "Bereiten Sie Ihren ErÃ¶ffnungszug vor.", userPlaceholder: "Benutzername", passPlaceholder: "Passwort", enterArena: "Arena Betreten",
                todayRiddle: "Heutiges RÃ¤tsel", settingsTitle: "Einstellungen", updatePass: "Passwort Aktualisieren", contactAdmin: "Admin Kontaktieren",
                submitTicket: "Ticket Einreichen", leaderboard: "Bestenliste", chess: "Schach", tricks: "Tricks", global: "Gesamt",
                adminInbox: "Admin Posteingang", userMgmt: "Benutzerverwaltung"
            },
            fr: {
                loginSub: "PrÃ©parez votre coup d'ouverture.", userPlaceholder: "Nom d'utilisateur", passPlaceholder: "Mot de passe", enterArena: "Entrer dans l'ArÃ¨ne",
                todayRiddle: "L'Ã©nigme d'aujourd'hui", settingsTitle: "ParamÃ¨tres", updatePass: "Mettre Ã  jour", contactAdmin: "Contacter l'Admin",
                submitTicket: "Soumettre", leaderboard: "Classement", chess: "Ã‰checs", tricks: "Astuces", global: "Mondial",
                adminInbox: "BoÃ®te de rÃ©ception Admin", userMgmt: "Gestion des Utilisateurs"
            }
        };

        let currentLang = 'en';

        document.getElementById('lang-selector').addEventListener('change', (e) => {
            if (e.target.value === 'ar') {
                alert("Arabic translations coming soon! / Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù‚Ø±ÙŠØ¨Ø§Ù‹!");
                e.target.value = currentLang;
                return;
            }
            currentLang = e.target.value;
            applyTranslations();
        });

        function applyTranslations() {
            const t = translations[currentLang];
            document.querySelectorAll('[data-i18n]').forEach(el => { el.innerText = t[el.getAttribute('data-i18n')]; });
            document.querySelectorAll('[data-i18n-ph]').forEach(el => { el.placeholder = t[el.getAttribute('data-i18n-ph')]; });
        }

        window.navigateTo = (id) => {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            const el = document.getElementById(id);
            if(el) el.classList.remove('hidden');
        };

        window.doLogout = async () => { 
            localStorage.removeItem('isAdmin'); 
            try { await signOut(auth); } catch(e) {}
            window.location.reload(); 
        };

        window.updateRole = async (name, newRole) => {
            await updateDoc(doc(db, "players", name), { role: newRole });
        };

        window.deleteUser = async (name) => {
            if(confirm(`Are you sure?`)) {
                await deleteDoc(doc(db, "players", name));
                await deleteDoc(doc(db, "leaderboard", name));
            }
        };

        window.quickAdd = async (name, amount) => {
            await setDoc(doc(db, "leaderboard", name), { name: name, chess: increment(amount) }, { merge: true });
        };

        window.deleteMsg = async (msgId) => {
            await deleteDoc(doc(db, "chat", msgId));
        };

        const toEmail = (n) => n.includes('@') ? n : `${n.toLowerCase().trim()}@chess.tour`;

        const setBtnLoading = (id, loading) => {
            const btn = document.getElementById(id);
            if(!btn) return;
            if(loading) {
                btn.classList.add('btn-loading');
                btn.dataset.original = btn.innerHTML;
                btn.innerHTML = `<div class="spinner"></div>`;
            } else {
                btn.classList.remove('btn-loading');
                btn.innerHTML = btn.dataset.original || btn.innerHTML;
            }
        };

        function applyPermissions(role) {
            document.querySelectorAll('.role-admin, .role-host, .role-not-admin').forEach(el => el.classList.add('hidden'));
            if (role === 'admin') {
                document.querySelectorAll('.role-admin, .role-host').forEach(el => el.classList.remove('hidden'));
            } else if (role === 'host') {
                document.querySelectorAll('.role-host, .role-not-admin').forEach(el => el.classList.remove('hidden'));
            } else {
                document.querySelectorAll('.role-not-admin').forEach(el => el.classList.remove('hidden'));
            }
        }

        onAuthStateChanged(auth, async (user) => {
            const isSuperAdmin = localStorage.getItem('isAdmin') === 'true';
            if (user || isSuperAdmin) {
                if (isSuperAdmin) {
                    currentUserData = { role: 'admin', username: 'SuperAdmin', id: 'admin' };
                } else {
                    const name = user.email.split('@')[0];
                    const userDoc = await getDoc(doc(db, "players", name));
                    if(userDoc.exists()) {
                        currentUserData = { ...userDoc.data(), id: name };
                    } else {
                        await setDoc(doc(db, "players", name), { username: name, role: 'participant' });
                        currentUserData = { username: name, role: 'participant', id: name };
                    }
                }
                applyPermissions(currentUserData.role);
                document.getElementById('user-display').innerHTML = `${currentUserData.username} <span class="role-badge badge-${currentUserData.role}">${currentUserData.role}</span>`;
                window.navigateTo('dashboard-page');
                renderLB(); // Rerender to show "((you!))"
            } else {
                window.navigateTo('login-page');
            }
        });

        document.getElementById('doLogin').onclick = async () => {
            const user = document.getElementById('login-user').value.trim();
            const pass = document.getElementById('login-pass').value;
            if(!user || !pass) return;
            setBtnLoading('doLogin', true);
            if(user.toLowerCase() === "admin" && pass === "0508") {
                localStorage.setItem('isAdmin', 'true');
                location.reload();
            } else {
                try { await signInWithEmailAndPassword(auth, toEmail(user), pass); } 
                catch(e) { alert("Login failed"); setBtnLoading('doLogin', false); }
            }
        };

        const toggleChat = () => document.getElementById('chatWindow').classList.toggle('open');
        document.getElementById('chatToggleBtn').onclick = toggleChat;
        document.getElementById('chatCloseBtn').onclick = () => document.getElementById('chatWindow').classList.remove('open');

        document.getElementById('sendChat').onclick = async () => {
            const val = document.getElementById('chat-input').value;
            if(!val || !currentUserData) return;
            await addDoc(collection(db, "chat"), { text: val, time: new Date(), author: currentUserData.username, role: currentUserData.role });
            document.getElementById('chat-input').value = "";
        };

        onSnapshot(query(collection(db, "chat"), orderBy("time", "asc")), (snap) => {
            const c = document.getElementById('chat-container'); 
            c.innerHTML = "";
            snap.forEach(d => {
                const data = d.data();
                const isOwn = currentUserData && (currentUserData.username === data.author);
                const isCurAdmin = currentUserData && (currentUserData.role === 'admin');
                const canDelete = isCurAdmin || (currentUserData && currentUserData.role === 'host' && isOwn);
                const msgClass = data.role === 'admin' ? 'chat-msg admin-msg' : 'chat-msg';
                const badge = data.role === 'admin' ? '<span class="role-badge badge-admin">ADMIN</span>' : '';
                c.innerHTML += `<div class="${msgClass}"><div class="author">${data.author} ${badge}</div><div>${data.text}</div>${canDelete ? `<i class="fa-solid fa-trash delete-msg-btn" onclick="deleteMsg('${d.id}')"></i>` : ''}</div>`;
            });
            c.scrollTop = c.scrollHeight;
        });

        const renderLB = () => {
            const container = document.getElementById('lb-display');
            container.innerHTML = "";
            let sorted = lbRawData.map(p => ({
                ...p, val: currentLBMode === 'chess' ? (p.chess || 0) : currentLBMode === 'tricks' ? (p.tricks || 0) : ((p.chess || 0) + (p.tricks || 0) - 200)
            })).sort((a,b) => b.val - a.val);

            const isAdmin = currentUserData && currentUserData.role === 'admin';

            sorted.forEach((p, i) => {
                const isYou = currentUserData && currentUserData.linkedLeaderboard === p.name;
                const medal = i === 0 ? 'ðŸ¥‡ ' : i === 1 ? 'ðŸ¥ˆ ' : i === 2 ? 'ðŸ¥‰ ' : `<span style="color:var(--text-sub); width:20px; display:inline-block;">${i+1}.</span> `;
                const controls = (isAdmin && currentLBMode === 'chess') ? `<span style="margin-left:10px; display:inline-flex; gap:3px;"><button class="inline-inc-btn" onclick="quickAdd('${p.name}', 5)">+5</button></span>` : '';
                const youBadge = isYou ? `<span style="color:var(--chess-green-bright); font-weight:bold; margin-left:5px; font-size:0.8rem;">((you!))</span>` : '';

                container.innerHTML += `
                    <div class="item-row ${isYou ? 'is-you' : ''}" style="animation-delay:${i*0.05}s">
                        <div style="display:flex; align-items:center;">${medal} <b style="margin-left:5px;">${p.name}</b> ${youBadge} ${controls}</div>
                        <b style="font-size:1.1rem; color:var(--chess-green-bright);">${p.val}</b>
                    </div>`;
            });
        };

        ['chess', 'tricks', 'global'].forEach(mode => {
            document.getElementById(`tab-${mode}`).onclick = (e) => {
                currentLBMode = mode;
                document.querySelectorAll('.lb-tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active'); renderLB();
            };
        });

        onSnapshot(collection(db, "leaderboard"), (snap) => { lbRawData = []; snap.forEach(d => lbRawData.push(d.data())); renderLB(); });

        document.getElementById('updateLB').onclick = async () => {
            const n = document.getElementById('lb-name').value;
            const c = parseInt(document.getElementById('lb-chess').value) || 0;
            const t = parseInt(document.getElementById('lb-trick').value) || 0;
            if(n) await setDoc(doc(db, "leaderboard", n), { name: n, chess: c, tricks: t }, {merge: true});
        };

        document.getElementById('createUser').onclick = async () => {
            const name = document.getElementById('new-name').value;
            const pass = document.getElementById('new-pass').value;
            if(!name || pass.length < 6) return alert("Min 6 chars");
            setBtnLoading('createUser', true);
            try {
                await createUserWithEmailAndPassword(auth, toEmail(name), pass);
                await setDoc(doc(db, "players", name), { username: name, role: 'participant' });
                alert("Created!");
            } catch(e) { alert(e.message); }
            setBtnLoading('createUser', false);
        };

        document.getElementById('doLink').onclick = async () => {
            const authUser = document.getElementById('link-user').value.trim();
            const lbUser = document.getElementById('link-lb').value.trim();
            if(!authUser || !lbUser) return alert("Fill both fields");
            await updateDoc(doc(db, "players", authUser), { linkedLeaderboard: lbUser });
            alert(`Linked ${authUser} to ${lbUser}`);
        };

        onSnapshot(collection(db, "players"), (snap) => {
            const list = document.getElementById('user-manager-list'); list.innerHTML = "";
            snap.forEach(d => {
                const u = d.data();
                if(d.id === 'admin') return; 
                list.innerHTML += `<div class="user-list-item"><div style="display:flex; justify-content:space-between;"><span><b>${d.id}</b> <small>${u.linkedLeaderboard || ''}</small></span><button class="btn-danger" onclick="deleteUser('${d.id}')">X</button></div><div style="display:flex; gap:5px; margin-top:5px;"><button class="btn-main" onclick="updateRole('${d.id}', 'admin')" style="padding:2px 8px; font-size:10px;">Admin</button><button class="btn-main" onclick="updateRole('${d.id}', 'participant')" style="padding:2px 8px; font-size:10px;">Part.</button></div></div>`;
            });
        });

        onSnapshot(query(collection(db, "messages"), orderBy("time", "desc")), (snap) => {
            const c = document.getElementById('inbox-container'); c.innerHTML = "";
            snap.forEach(d => c.innerHTML += `<div style="background:#1a1a1a; padding:10px; margin-bottom:5px; border-radius:8px; border-left:3px solid var(--chess-green)"><b>${d.data().from}:</b> ${d.data().text}</div>`);
        });

        document.getElementById('sendSupport').onclick = () => {
            const val = document.getElementById('support-input').value;
            if(!val) return;
            addDoc(collection(db, "messages"), { from: currentUserData.username, text: val, time: new Date() });
            document.getElementById('support-input').value = "";
            alert("Sent!");
        };

        document.getElementById('saveRiddle').onclick = () => setDoc(doc(db, "content", "riddle"), { text: document.getElementById('edit-riddle-text').value, url: document.getElementById('edit-riddle-url').value });
        document.getElementById('theme-toggle').onclick = (e) => { 
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            e.target.className = isDark ? "fa-solid fa-sun" : "fa-solid fa-moon";
        };
        
        onSnapshot(doc(db, "content", "riddle"), (d) => {
            if(d.exists()) {
                document.getElementById('riddle-text').innerText = d.data().text;
                const img = document.getElementById('riddle-img');
                if(d.data().url) { img.src = d.data().url; img.style.display = 'block'; } else { img.style.display = 'none'; }
            }
        });

        document.getElementById('doChangePass').onclick = async () => {
            const p = document.getElementById('change-pass-input').value;
            if(p.length < 6) return alert("Min 6 chars");
            await updatePassword(auth.currentUser, p);
            alert("Updated!");
        };
    </script>
</body>
</html>